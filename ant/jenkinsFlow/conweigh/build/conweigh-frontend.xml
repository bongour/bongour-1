<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<project name="jenkins" basedir=".">
<taskdef resource="net/sf/antcontrib/antcontrib.properties"/>
<property environment="env"/>
<tstamp>
        <format property="current.time"
             pattern="yyyyMMddHHmm"/>
</tstamp>
<property file="../properties/${env}.properties"/>

    <target name="buildEnvironment">
        <if>
            <available file="/var/www/backup" type="dir" />
            <then>
                <echo message="Backup direcotry already exists" />
            </then>
        <else>
            <echo message="Creating backup directory in /var/www/..." />
            <mkdir dir="/var/www/backup" />
        </else>
        </if>
        <exec executable="/bin/sh">
            <arg value="-c" />
            <arg value="sudo git clone ${repoUrl} -b ${branchName} /var/www/html/${vDirName}" />
        </exec>
        <if>
            <available file="/var/www/html/${dirName}" type="dir" />
            <then>
                <move todir="/var/www/backup/${dirName}${current.time}">
                    <fileset dir="/var/www/html/${dirName}" defaultexcludes="no"/>
                </move>
            </then>
            <else>
                <echo message="Directory not found...Creating directory ${dirName}"/>
            </else>
        </if>
        <move todir="/var/www/html/${dirName}">
            <fileset dir="/var/www/html/${vDirName}/" defaultexcludes="no"/>
        </move>
        <chown owner="apache" verbose="true">
            <dirset dir="/var/www/html/${dirName}"/>
        </chown>
        <chmod  perm="755" verbose="true">
            <dirset dir="/var/www/html/${dirName}"/>
        </chmod>
    </target>  

    <target name="reDeployment">
        <echo message="Redploying Tag ${tagName} on Live server"/>
        <if>
            <available file="/var/www/backup" type="dir" />
            <then>
                <echo message="Backup direcotry already exists" />
            </then>
        <else>
            <echo message="Creating backup directory in /var/www/..." />
            <mkdir dir="/var/www/backup/"/>
        </else>
        </if>
        <exec executable="/bin/sh">
            <arg value="-c" />
            <arg value="sudo git clone ${repoUrl} /var/www/html/${vDirName}" />
        </exec>
        <chown file="/var/www/html/${vDirName}" owner="ec2-user"/>
        <exec dir="/var/www/html/${vDirName}" executable="/bin/sh">
            <arg value="-c" />
            <arg value="git checkout ${tagName}"/>
        </exec>

        <if>
            <available file="/var/www/html/${dirName}" type="dir" />
            <then>
                <move todir="/var/www/backup/${dirName}${current.time}/">
                    <fileset dir="/var/www/html/${dirName}" defaultexcludes="no"/>
                </move>
            </then>
            <else>
                <echo message="Directory not found...Creating directory ${dirName}"/>
            </else>
        </if>
        <move todir="/var/www/html/${dirName}">
            <fileset dir="/var/www/html/${vDirName}/" defaultexcludes="no"/>
        </move>
        <chown owner="apache" verbose="true">
            <dirset dir="/var/www/html/${dirName}"/>
        </chown>
        <chmod  perm="755" verbose="true">
            <dirset dir="/var/www/html/${dirName}"/>
        </chmod>
    </target>
    
    <target name="prodDeployment">
        <if>
            <available file="/var/www/backup" type="dir" />
            <then>
                <echo message="Backup direcotry already exists" />
            </then>
        <else>
            <echo message="Creating backup directory in /var/www/..." />
            <mkdir dir="/var/www/backup/"/>
        </else>
        </if>
        <exec executable="/bin/sh">
            <arg value="-c" />
            <arg value="sudo git clone -b 'Rel-${env.PROMOTED_NUMBER}' ${repoUrl} /var/www/html/${vDirName}" />
        </exec>
        <exec dir="/var/www/html/${vDirName}" executable="/bin/sh">
            <arg value="-c" />
            <arg value="git checkout master-poc"/>
        </exec>
        <exec dir="/var/www/html/${vDirName}" executable="/bin/sh">
            <arg value="-c" />
            <arg value="git rebase 'Rel-${env.PROMOTED_NUMBER}'"/>
        </exec>
        <exec dir="/var/www/html/${vDirName}" executable="/bin/sh">
            <arg value="-c" />
            <arg value="git push -f origin master-poc"/>
        </exec>
        <exec dir="/var/www/html/${vDirName}" executable="/bin/sh">
            <arg value="-c" />
            <arg value="git tag 'v1.0.${env.PROMOTED_NUMBER}'"/>
        </exec>
        <exec dir="/var/www/html/${vDirName}" executable="/bin/sh">
            <arg value="-c" />
            <arg value="git push origin --tags"/>
        </exec>
        <exec dir="/var/www/html/${vDirName}" executable="/bin/sh">
            <arg value="-c" />
            <arg value="git tag -l"/>
        </exec>
        <if>
            <available file="/var/www/html/${dirName}" type="dir" />
            <then>
                <move todir="/var/www/backup/${dirName}${current.time}">
                    <fileset dir="/var/www/html/${dirName}" defaultexcludes="no"/>
                </move>
            </then>
            <else>
                <echo message="Directory not found...Creating directory ${dirName}"/>
            </else>
        </if>
        <move todir="/var/www/html/${dirName}">
            <fileset dir="/var/www/html/${vDirName}/" defaultexcludes="no"/>
        </move>
        <chown owner="apache" verbose="true">
            <dirset dir="/var/www/html/${dirName}"/>
        </chown>
        <chmod  perm="755" verbose="true">
            <dirset dir="/var/www/html/${dirName}"/>
        </chmod>
    </target>
    <target name="qaSignoff">
        <chown owner="ec2-user" verbose="true">
            <dirset dir="/var/www/html/${dirName}"/>
        </chown>
        <exec dir="/var/www/html/${dirName}" executable="/bin/sh">
            <arg value="-c" />
            <arg value="git branch -l"/>
        </exec>
        <exec dir="/var/www/html/${dirName}" executable="/bin/sh">
            <arg value="-c" />
            <arg value="git branch 'Rel-${env.PROMOTED_NUMBER}'"/>
        </exec>
        <exec dir="/var/www/html/${dirName}" executable="/bin/sh">
            <arg value="-c" />
            <arg value="git push origin 'Rel-${env.PROMOTED_NUMBER}'"/>
        </exec>
        <exec dir="/var/www/html/${dirName}" executable="/bin/sh">
            <arg value="-c" />
            <arg value="git branch -l"/>
        </exec>
        <chown owner="apache" verbose="true">
            <dirset dir="/var/www/html/${dirName}"/>
        </chown>
    </target>
</project>