<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<project name="jenkins" basedir=".">
<taskdef resource="net/sf/antcontrib/antcontrib.properties"/>
<tstamp>
        <format property="current.time"
             pattern="yyyyMMddHHmm"/>
</tstamp>
<property file="../properties/${env}.properties"/>

    <target name="buildEnvironment">
        <if>
            <available file="/var/www/backup" type="dir" />
            <then>
                <echo message="Backup direcotry already exists" />
            </then>
        <else>
            <echo message="Creating backup directory in /var/www/..." />
            <mkdir dir="/var/www/backup" />
        </else>
        </if>
        <mkdir dir="/var/www/html/${vDirName}"/>
        <chown owner="ec2-user" verbose="true">
            <dirset dir="/var/www/html/${vDirName}"/>
        </chown>
        <exec executable="/bin/sh">
            <arg value="-c" />
            <arg value="sudo su - ec2-user -c 'git clone ${repoUrl} -b ${branchName} /var/www/html/${vDirName}'" />
        </exec>
        <if>
            <available file="/var/www/html/${dirName}" type="dir" />
            <then>
                <move todir="/var/www/backup/${dirName}${current.time}">
                    <fileset dir="/var/www/html/${dirName}" defaultexcludes="no"/>
                </move>
            </then>
            <else>
                <echo message="Directory not found...Creating directory ${dirName}"/>
            </else>
        </if>
        <move todir="/var/www/html/${dirName}">
            <fileset dir="/var/www/html/${vDirName}/" defaultexcludes="no"/>
        </move>
        <echo file="/var/www/html/${dirName}/env.js" message="${url}" append="true"/>
        <chown owner="apache" verbose="true">
            <dirset dir="/var/www/html/${dirName}"/>
        </chown>
        <chmod  perm="755" verbose="true">
            <dirset dir="/var/www/html/${dirName}"/>
        </chmod>
        <exec executable="/bin/sh">
            <arg value="-c" />
            <arg value="sed -i 's|web.onesignal.auto.54eebb47-16d1-4f2f-8c9e-9bb7522bb051|web.onesignal.auto.26339961-08fd-44e5-8197-7ce61bb1927b|g' /var/www/html/${dirName}/app/js/app.js" />
        </exec>
        <exec executable="/bin/sh">
            <arg value="-c" />
            <arg value="sed -i 's|47b66cf3-2793-41b2-832e-7d38f07c5cd2|87199a18-edc0-4682-8f69-6dd4da1f4886|g' /var/www/html/${dirName}/app/js/app.js" />
        </exec>
        <exec executable="/bin/sh">
            <arg value="-c" />
            <arg value="sed -i 's|https://dev-instantconsult-com.onesignal.com|https://test-instantconsult-com.onesignal.com|g' /var/www/html/${dirName}/app/js/app.js" />
        </exec>
        <exec executable="/bin/sh" dir="/var/www/backup">
            <arg value="-c" />
            <arg value="sudo rm -rf `ls -t /var/www/backup/|awk 'NR>5'`"/>
	</exec>
    </target>  

    <target name="reDeployment">
        <echo message="Redeploying Tag ${tagName} on Live server"/>
        <if>
            <available file="/var/www/backup" type="dir" />
            <then>
                <echo message="Backup direcotry already exists" />
            </then>
        <else>
            <echo message="Creating backup directory in /var/www/..." />
            <mkdir dir="/var/www/backup/"/>
        </else>
        </if>
        <mkdir dir="/var/www/html/${vDirName}"/>
        <chown owner="ec2-user" verbose="true">
            <dirset dir="/var/www/html/${vDirName}"/>
        </chown>
        <exec executable="/bin/sh">
            <arg value="-c" />
            <arg value="sudo su - ec2-user -c 'git clone ${repoUrl} /var/www/html/${vDirName}'" />
        </exec>
        <chown owner="ec2-user">
            <dirset dir="/var/www/html/${vDirName}"/>
        </chown>
        <exec dir="/var/www/html/${vDirName}" executable="/bin/sh">
            <arg value="-c" />
            <arg value="git checkout ${tagName}"/>
        </exec>

        <if>
            <available file="/var/www/html/${dirName}" type="dir" />
            <then>
                <move todir="/var/www/backup/${dirName}${current.time}/">
                    <fileset dir="/var/www/html/${dirName}" defaultexcludes="no"/>
                </move>
            </then>
            <else>
                <echo message="Directory not found...Creating directory ${dirName}"/>
            </else>
        </if>
        <move todir="/var/www/html/${dirName}">
            <fileset dir="/var/www/html/${vDirName}/" defaultexcludes="no"/>
        </move>
        <echo file="/var/www/html/${dirName}/env.js" message="${url}" append="true"/>
        <chown owner="apache" verbose="true">
            <dirset dir="/var/www/html/${dirName}"/>
        </chown>
        
        <chmod  perm="755" verbose="true">
            <dirset dir="/var/www/html/${dirName}"/>
        </chmod>
        <exec executable="/bin/sh">
            <arg value="-c" />
            <arg value="sed -i 's|web.onesignal.auto.26339961-08fd-44e5-8197-7ce61bb1927b|web.onesignal.auto.69735df3-8f8c-40d7-a01f-205a16828de8|g' /var/www/html/${dirName}/app/js/app.js" />
        </exec>
        <exec executable="/bin/sh">
            <arg value="-c" />
            <arg value="sed -i 's|87199a18-edc0-4682-8f69-6dd4da1f4886|5433f97a-b90d-4f6f-a507-e0aa0c7f462b|g' /var/www/html/${dirName}/app/js/app.js" />
        </exec>
        <exec executable="/bin/sh">
            <arg value="-c" />
            <arg value="sed -i 's|https://test-instantconsult-com.onesignal.com|https://webgp-instantconsult-com.onesignal.com|g' /var/www/html/${dirName}/app/js/app.js" />
        </exec>
        <exec executable="/bin/sh" dir="/var/www/backup">
            <arg value="-c" />
            <arg value="sudo rm -rf `ls -t /var/www/backup/|awk 'NR>5'`"/>
	</exec>
    </target>
    
    <target name="prodDeployment">
        <if>
            <available file="/var/www/backup" type="dir" />
            <then>
                <echo message="Backup direcotry already exists" />
            </then>
        <else>
            <echo message="Creating backup directory in /var/www/..." />
            <mkdir dir="/var/www/backup/"/>
        </else>
        </if>
        <mkdir dir="/var/www/html/${vDirName}"/>
        <chown owner="ec2-user" verbose="true">
            <dirset dir="/var/www/html/${vDirName}"/>
        </chown>
        <exec executable="/bin/sh">
            <arg value="-c" />
            <arg value="sudo su - ec2-user -c 'git clone -b Rel-${promotedNumber} ${repoUrl} /var/www/html/${vDirName}'" />
        </exec>
        <chown owner="ec2-user">
            <dirset dir="/var/www/html/${vDirName}"/>
        </chown>
        <exec dir="/var/www/html/${vDirName}" executable="/bin/sh">
            <arg value="-c" />
            <arg value="git checkout ${branchName}"/>
        </exec>
        <exec dir="/var/www/html/${vDirName}" executable="/bin/sh">
            <arg value="-c" />
            <arg value="git rebase Rel-${promotedNumber}"/>
        </exec>
        <exec executable="/bin/sh">
            <arg value="-c" />
            <arg value="sudo su - ec2-user -c 'git -C /var/www/html/${vDirName}/ push -f origin ${branchName}'"/>
        </exec>
        <exec dir="/var/www/html/${vDirName}" executable="/bin/sh">
            <arg value="-c" />
            <arg value="git tag v1.0.${promotedNumber}"/>
        </exec>
        <exec executable="/bin/sh">
            <arg value="-c" />
            <arg value="sudo su - ec2-user -c 'git -C /var/www/html/${vDirName}/ push origin --tags'"/>
        </exec>
        <exec dir="/var/www/html/${vDirName}" executable="/bin/sh">
            <arg value="-c" />
            <arg value="git tag -l"/>
        </exec>
        <if>
            <available file="/var/www/html/${dirName}" type="dir" />
            <then>
                <move todir="/var/www/backup/${dirName}${current.time}">
                    <fileset dir="/var/www/html/${dirName}" defaultexcludes="no"/>
                </move>
            </then>
            <else>
                <echo message="Directory not found...Creating directory ${dirName}"/>
            </else>
        </if>
        <move todir="/var/www/html/${dirName}">
            <fileset dir="/var/www/html/${vDirName}/" defaultexcludes="no"/>
        </move>
        <echo file="/var/www/html/${dirName}/env.js" message="${url}" append="true"/>
        <chown owner="apache">
            <dirset dir="/var/www/html/${dirName}"/>
        </chown>
        <chmod  perm="755">
            <dirset dir="/var/www/html/${dirName}"/>
        </chmod>
        <exec executable="/bin/sh">
            <arg value="-c" />
            <arg value="sed -i 's|web.onesignal.auto.54eebb47-16d1-4f2f-8c9e-9bb7522bb051|web.onesignal.auto.528b6caf-1e6b-4608-b4e6-faa03f146a9c|g' /var/www/html/${dirName}/app/js/app.js" />
        </exec>
        <exec executable="/bin/sh">
            <arg value="-c" />
            <arg value="sed -i 's|47b66cf3-2793-41b2-832e-7d38f07c5cd2|bdf0c425-3c9d-4057-bcb7-8fcf4110ff13|g' /var/www/html/${dirName}/app/js/app.js" />
        </exec>
        <exec executable="/bin/sh">
            <arg value="-c" />
            <arg value="sed -i 's|https://dev-instantconsult-com.onesignal.com|https://webgp-instantconsult-com.onesignal.com|g' /var/www/html/${dirName}/app/js/app.js" />
        </exec>
        <exec executable="/bin/sh" dir="/var/www/backup">
            <arg value="-c" />
            <arg value="sudo rm -rf `ls -t /var/www/backup/|awk 'NR>5'`"/>
	</exec>
    </target>
    <target name="qaSignoff">
        <chown owner="ec2-user">
            <dirset dir="/var/www/html/${dirName}"/>
        </chown>
        <exec dir="/var/www/html/${dirName}" executable="/bin/sh">
            <arg value="-c" />
            <arg value="git branch -l"/>
        </exec>
        <exec dir="/var/www/html/${dirName}/" executable="/bin/sh">
            <arg value="-c" />
            <arg value="git branch Rel-${promotedNumber}"/>
        </exec>
        <exec executable="/bin/sh">
            <arg value="-c" />
            <arg value="sudo su - ec2-user -c 'git -C /var/www/html/${dirName}/ push origin Rel-${promotedNumber}'"/>
        </exec>
        <exec dir="/var/www/html/${dirName}" executable="/bin/sh">
            <arg value="-c" />
            <arg value="git branch -l"/>
        </exec>
        <chown owner="apache">
            <dirset dir="/var/www/html/${dirName}"/>
        </chown>
        <exec executable="/bin/sh" dir="/var/www/backup">
            <arg value="-c" />
            <arg value="sudo rm -rf `ls -t /var/www/backup/|awk 'NR>5'`"/>
	</exec>
    </target>
</project>